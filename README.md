# TIKTOK-WEB-API

é«˜æ€§èƒ½ Node.js HTTP æœåŠ¡ï¼Œæ”¯æŒ MySQL å’Œ Redis è¿æ¥æ± ï¼Œä¼˜åŒ–é«˜å¹¶å‘åœºæ™¯ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½ HTTP æœåŠ¡å™¨** - åŸºäº Expressï¼Œæ”¯æŒ Gzip å‹ç¼©
- ğŸ—„ï¸ **MySQL è¿æ¥æ± ** - ä½¿ç”¨ mysql2 å®ç°é«˜æ•ˆçš„æ•°æ®åº“è¿æ¥ç®¡ç†
- âš¡ **Redis è¿æ¥æ± ** - ä½¿ç”¨ ioredis å®ç°é«˜æ€§èƒ½ç¼“å­˜
- ğŸ”„ **é›†ç¾¤æ¨¡å¼** - æ”¯æŒå¤šè¿›ç¨‹è´Ÿè½½å‡è¡¡ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- ğŸ”¥ **çƒ­æ›´æ–°** - è‡ªåŠ¨ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œé›¶åœæœºæ—¶é—´æ»šåŠ¨é‡å¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤** - Helmet å®‰å…¨å¤´ã€CORSã€è¯·æ±‚é™æµ
- ğŸ“Š **å¥åº·æ£€æŸ¥** - å®æ—¶ç›‘æ§ MySQL å’Œ Redis è¿æ¥çŠ¶æ€
- ğŸ¯ **é«˜å¹¶å‘ä¼˜åŒ–** - è¿æ¥æ± ã€å‹ç¼©ã€ç¼“å­˜ç­‰å¤šé‡ä¼˜åŒ–

## ğŸ“‹ å‰ç½®è¦æ±‚

- Node.js >= 16.0.0
- MySQL >= 5.7
- Redis >= 5.0

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒ

é¡¹ç›®ç°åœ¨ä¼šæ ¹æ®è¿è¡Œçš„æ“ä½œç³»ç»Ÿè‡ªåŠ¨åŠ è½½é…ç½®ï¼š
- **Windows / macOS**: åŠ è½½ `config/config.dev.js` (å¼€å‘ç¯å¢ƒ)
- **Linux**: åŠ è½½ `config/config.prod.js` (ç”Ÿäº§ç¯å¢ƒ)

æ‰€æœ‰ç¯å¢ƒéƒ½ä¼šé¦–å…ˆåŠ è½½ `config/config.default.js` ä½œä¸ºåŸºç¡€é…ç½®ã€‚

è¯·æ ¹æ®æ‚¨çš„éœ€æ±‚ä¿®æ”¹è¿™äº›é…ç½®æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“å’Œ Redis å¯†ç ã€‚

**å¼€å‘ç¯å¢ƒé…ç½®:** `config/config.dev.js`
```javascript
// config/config.dev.js
module.exports = {
  mysql: {
    database: 'tiktok_db_dev',
    password: 'your_dev_password'
  },
  redis: {
    db: 1,
  },
  server: {
    port: 3001,
  }
};
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®:** `config/config.prod.js`
```javascript
// config/config.prod.js
module.exports = {
  mysql: {
    host: 'your_prod_mysql_host',
    password: 'your_prod_mysql_password',
    database: 'tiktok_db_prod',
  },
  redis: {
    host: 'your_prod_redis_host',
    password: 'your_prod_redis_password',
  },
};
```

### 3. å¯åŠ¨æœåŠ¡

#### å•è¿›ç¨‹æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
npm run dev
```

#### å•è¿›ç¨‹æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
npm start
```

#### é›†ç¾¤æ¨¡å¼ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
npm run cluster
```

é›†ç¾¤æ¨¡å¼ä¼šè‡ªåŠ¨æ ¹æ® CPU æ ¸å¿ƒæ•°åˆ›å»ºå·¥ä½œè¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°é‡ã€‚

**çƒ­æ›´æ–°åŠŸèƒ½**ï¼š
- å¼€å‘ç¯å¢ƒï¼ˆWindows/Macï¼‰é»˜è®¤å¯ç”¨çƒ­æ›´æ–°
- è‡ªåŠ¨ç›‘å¬ä»£ç æ–‡ä»¶å˜åŒ–ï¼ˆ.js æ–‡ä»¶ï¼‰
- æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–åï¼Œè‡ªåŠ¨æ»šåŠ¨é‡å¯å·¥ä½œè¿›ç¨‹ï¼ˆé›¶åœæœºæ—¶é—´ï¼‰
- å¯é€šè¿‡ `config/config.dev.js` ä¸­çš„ `server.hotReload` é…ç½®é¡¹ç¦ç”¨

## ğŸ“ é¡¹ç›®ç»“æ„

```
TIKTOK-WEB-API/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.default.js  # é»˜è®¤é…ç½®
â”‚   â”œâ”€â”€ config.dev.js      # å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ config.prod.js     # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ index.js           # é…ç½®åŠ è½½å™¨
â”‚   â”œâ”€â”€ database.js        # MySQL è¿æ¥æ± é…ç½®
â”‚   â””â”€â”€ redis.js           # Redis è¿æ¥æ± é…ç½®
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ hotReload.js       # çƒ­æ›´æ–°ç®¡ç†å™¨
â”œâ”€â”€ server.js              # HTTP æœåŠ¡å™¨ä¸»æ–‡ä»¶
â”œâ”€â”€ cluster.js             # é›†ç¾¤æ¨¡å¼å¯åŠ¨æ–‡ä»¶
â”œâ”€â”€ package.json           # é¡¹ç›®ä¾èµ–é…ç½®
â””â”€â”€ README.md              # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”Œ API æ¥å£

### å¥åº·æ£€æŸ¥

```
GET /health
```

è¿”å›æœåŠ¡å™¨å’Œæ•°æ®åº“è¿æ¥çŠ¶æ€ã€‚

### ç¤ºä¾‹æ¥å£

- `GET /api/users` - æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ï¼ˆMySQLï¼‰
- `GET /api/cache/:key` - è·å–ç¼“å­˜ï¼ˆRedisï¼‰
- `POST /api/cache/:key` - è®¾ç½®ç¼“å­˜ï¼ˆRedisï¼‰
- `GET /api/user/:id` - æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…ï¼ˆMySQL + Redis ç¼“å­˜ï¼‰

### TikTok API æ¥å£

#### å‘é€æ–‡æœ¬æ¶ˆæ¯

```
POST /api/tiktok/send-text
```

**è¯·æ±‚ä½“å‚æ•°:**

```json
{
  "toUid": "ç›®æ ‡ç”¨æˆ·ID (å¿…å¡«)",
  "textMsg": "æ¶ˆæ¯å†…å®¹ (å¿…å¡«)",
  "cookieParams": "cookieå­—ç¬¦ä¸²æˆ–å¯¹è±¡ (å¿…å¡«)",
  "proxy": "http://proxy:port",
  "user_agent": "User-Agentå­—ç¬¦ä¸²",
  "device_id": "è®¾å¤‡ID",
  "createSequenceId": 10000,
  "sendSequenceId": 10013
}
```

**å‚æ•°è¯´æ˜:**

- `toUid`: ç›®æ ‡ç”¨æˆ·çš„ TikTok UIDï¼ˆå¿…å¡«ï¼‰
- `textMsg`: è¦å‘é€çš„æ¶ˆæ¯æ–‡æœ¬ï¼ˆå¿…å¡«ï¼‰
- `cookieParams`: TikTok cookiesï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼ˆå¦‚ "sessionid=xxx;msToken=yyy"ï¼‰æˆ–å¯¹è±¡ï¼ˆå¦‚ `{"sessionid": "xxx", "msToken": "yyy"}`ï¼‰ï¼ˆå¿…å¡«ï¼‰
- `proxy`: ä»£ç†åœ°å€ï¼ˆå¯é€‰ï¼‰
- `user_agent`: è‡ªå®šä¹‰ User-Agentï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
- `device_id`: è®¾å¤‡IDï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰
- `createSequenceId`: åˆ›å»ºå¯¹è¯çš„åºåˆ—IDï¼ˆå¯é€‰ï¼‰
- `sendSequenceId`: å‘é€æ¶ˆæ¯çš„åºåˆ—IDï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹:**

æˆåŠŸå“åº”:
```json
{
  "success": true,
  "code": 0,
  "message": "å‘é€æ¶ˆæ¯æˆåŠŸ",
  "data": {
    "server_message_id": "æ¶ˆæ¯ID",
    "status": 0
  }
}
```

å¤±è´¥å“åº”:
```json
{
  "success": false,
  "code": -1,
  "message": "å‘é€æ¶ˆæ¯å¤±è´¥",
  "data": {}
}
```

**è¿”å›ç è¯´æ˜:**

- `0`: å‘é€æˆåŠŸ
- `-1`: å‘é€å¤±è´¥
- `-10001`: è´¦æˆ·å¯èƒ½å·²é€€å‡º
- `-10002`: å¼‚å¸¸é”™è¯¯
- `10001`: é‡å¤å‘é€æˆ–æ¥æ”¶è€…è¢«é™åˆ¶
- `10002`: å‘é€å¤ªå¿«
- `10004`: å‘é€ç«¯é™åˆ¶ç§ä¿¡

**ä½¿ç”¨ç¤ºä¾‹:**

```bash
curl -X POST http://localhost:3000/api/tiktok/send-text \
  -H "Content-Type: application/json" \
  -d '{
    "toUid": "1234567890",
    "textMsg": "Hello, TikTok!",
    "cookieParams": "sessionid=your_session_id;msToken=your_ms_token;multi_sids=1234567890"
  }'
```

æˆ–è€…ä½¿ç”¨å¯¹è±¡æ ¼å¼çš„ cookies:

```bash
curl -X POST http://localhost:3000/api/tiktok/send-text \
  -H "Content-Type: application/json" \
  -d '{
    "toUid": "1234567890",
    "textMsg": "Hello, TikTok!",
    "cookieParams": {
      "sessionid": "your_session_id",
      "msToken": "your_ms_token",
      "multi_sids": "1234567890"
    },
    "proxy": "http://127.0.0.1:7890"
  }'
```

## âš™ï¸ æ€§èƒ½ä¼˜åŒ–

### 1. MySQL è¿æ¥æ± é…ç½®

- **connectionLimit**: è¿æ¥æ± å¤§å°ï¼ˆé»˜è®¤ 20ï¼‰
- **queueLimit**: é˜Ÿåˆ—é™åˆ¶ï¼ˆ0 è¡¨ç¤ºæ— é™åˆ¶ï¼‰
- **enableKeepAlive**: ä¿æŒè¿æ¥æ´»è·ƒ
- **connectTimeout**: è¿æ¥è¶…æ—¶ï¼ˆ10 ç§’ï¼‰

### 2. Redis è¿æ¥æ± é…ç½®

- **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿
- **è¿æ¥è¶…æ—¶**: 10 ç§’
- **å‘½ä»¤è¶…æ—¶**: 5 ç§’
- **ä¿æŒè¿æ¥æ´»è·ƒ**: 30 ç§’å¿ƒè·³

### 3. HTTP æœåŠ¡å™¨ä¼˜åŒ–

- **Gzip å‹ç¼©**: å‡å°‘å“åº”ä½“ç§¯
- **è¯·æ±‚é™æµ**: é˜²æ­¢æ¶æ„è¯·æ±‚
- **å®‰å…¨å¤´**: Helmet ä¿æŠ¤
- **é›†ç¾¤æ¨¡å¼**: å¤šè¿›ç¨‹è´Ÿè½½å‡è¡¡

### 4. çƒ­æ›´æ–°åŠŸèƒ½

- **è‡ªåŠ¨ç›‘å¬**: ç›‘å¬ `server.js`ã€`cluster.js`ã€`config/`ã€`tiktokWeb/`ã€`utils/` ç›®å½•ä¸‹çš„ `.js` æ–‡ä»¶
- **æ»šåŠ¨é‡å¯**: æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–åï¼Œé€ä¸ªé‡å¯å·¥ä½œè¿›ç¨‹ï¼Œç¡®ä¿é›¶åœæœºæ—¶é—´
- **é˜²æŠ–æœºåˆ¶**: é»˜è®¤ 1 ç§’é˜²æŠ–å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹é‡å¯
- **æ™ºèƒ½å¿½ç•¥**: è‡ªåŠ¨å¿½ç•¥ `node_modules`ã€`.git`ã€æ—¥å¿—æ–‡ä»¶ç­‰
- **ç¯å¢ƒæ§åˆ¶**: å¼€å‘ç¯å¢ƒï¼ˆWindows/Macï¼‰é»˜è®¤å¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒï¼ˆLinuxï¼‰é»˜è®¤ç¦ç”¨

### 5. é«˜å¹¶å‘å»ºè®®

1. **è°ƒæ•´è¿æ¥æ± å¤§å°**: æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ `config/config.prod.js` ä¸­çš„ `connectionLimit`
2. **ä½¿ç”¨é›†ç¾¤æ¨¡å¼**: ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `npm run cluster`
3. **å¯ç”¨ Redis ç¼“å­˜**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
4. **ç›‘æ§æ€§èƒ½**: å®šæœŸæ£€æŸ¥ `/health` æ¥å£
5. **è´Ÿè½½å‡è¡¡**: ä½¿ç”¨ Nginx ç­‰åå‘ä»£ç†è¿›è¡Œè´Ÿè½½å‡è¡¡
6. **çƒ­æ›´æ–°é…ç½®**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ç¦ç”¨çƒ­æ›´æ–°ï¼Œé€šè¿‡ CI/CD æµç¨‹éƒ¨ç½²

## ğŸ”§ é…ç½®è¯´æ˜

æ‰€æœ‰é…ç½®é¡¹éƒ½åœ¨ `config/` ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸­è¿›è¡Œç®¡ç†ã€‚`config.default.js` åŒ…å«äº†æ‰€æœ‰åŸºç¡€é…ç½®ï¼Œè€Œ `config.dev.js` å’Œ `config.prod.js` åˆ†åˆ«ç”¨äºè¦†ç›–å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒçš„ç‰¹å®šè®¾ç½®ã€‚

### æœåŠ¡å™¨å‚æ•°

| å‚æ•° | æ–‡ä»¶ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|-------------|--------|
| `port` | `config.default.js` | æœåŠ¡ç«¯å£ | 3000 |
| `workers`| `config.default.js` | å·¥ä½œè¿›ç¨‹æ•° | CPU æ ¸å¿ƒæ•° |
| `hotReload` | `config.default.js` | æ˜¯å¦å¯ç”¨çƒ­æ›´æ–° | true |
| `hotReloadDebounce` | `config.default.js` | çƒ­æ›´æ–°é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ | 1000 |

### MySQL & Redis

MySQL å’Œ Redis çš„æ‰€æœ‰è¿æ¥å‚æ•°éƒ½åœ¨ `config/config.default.js` ä¸­å®šä¹‰ï¼Œå¹¶å¯ä»¥åœ¨ç‰¹å®šç¯å¢ƒçš„é…ç½®æ–‡ä»¶ä¸­è¢«è¦†ç›–ã€‚

## ğŸ› ï¸ å¼€å‘

### å¼€å‘æ¨¡å¼

```bash
npm run dev
```

ä½¿ç”¨ nodemon è‡ªåŠ¨é‡å¯ï¼ˆéœ€è¦å®‰è£… nodemonï¼‰ã€‚

### ç”Ÿäº§éƒ¨ç½²

1. è®¾ç½®ç¯å¢ƒå˜é‡
2. ä½¿ç”¨é›†ç¾¤æ¨¡å¼å¯åŠ¨ï¼š`npm run cluster`
3. ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹ï¼ˆæ¨èï¼‰ï¼š

```bash
npm install -g pm2
pm2 start cluster.js --name tiktok-api
pm2 save
pm2 startup
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¡¨ç»“æ„**: ç¤ºä¾‹æ¥å£éœ€è¦ç›¸åº”çš„æ•°æ®åº“è¡¨ï¼Œè¯·æ ¹æ®å®é™…éœ€æ±‚åˆ›å»º
2. **Redis å†…å­˜**: æ³¨æ„ Redis å†…å­˜ä½¿ç”¨ï¼Œåˆç†è®¾ç½®è¿‡æœŸæ—¶é—´
3. **è¿æ¥æ•°é™åˆ¶**: æ³¨æ„ MySQL å’Œ Redis çš„æœ€å¤§è¿æ¥æ•°é™åˆ¶
4. **æ—¥å¿—ç›‘æ§**: ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®æ—¥å¿—æ”¶é›†å’Œç›‘æ§ç³»ç»Ÿ

## ğŸ“„ è®¸å¯è¯

MIT
